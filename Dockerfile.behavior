# BEHAVIOR-1K / OmniGibson Docker Image
# Built from official NVIDIA Isaac Sim container
# Requires NGC credentials to pull base image

FROM nvcr.io/nvidia/isaac-sim:4.5.0

LABEL maintainer="yubo"
LABEL description="BEHAVIOR-1K / OmniGibson environment with SSH support"

# ============================================
# Environment Variables
# ============================================
# NVIDIA/Isaac Sim EULA acceptance
ENV ACCEPT_EULA=Y
ENV PRIVACY_CONSENT=Y
ENV OMNI_KIT_ACCEPT_EULA=YES
# OmniGibson asset path (persistent volume)
ENV OMNIGIBSON_ASSET_PATH=/workspace/omnigibson_assets
ENV GIBSON_ASSETS_PATH=/workspace/omnigibson_assets

# Switch to root for system setup
USER root

# ============================================
# System Packages
# ============================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssh-server \
    sudo \
    git \
    git-lfs \
    wget \
    curl \
    vim \
    htop \
    tmux \
    unzip \
    zip \
    net-tools \
    iputils-ping \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# ============================================
# GitHub CLI
# ============================================
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y --no-install-recommends gh \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ============================================
# SSH Configuration
# ============================================
RUN mkdir -p /run/sshd \
    && sed -i "s/#PermitRootLogin.*/PermitRootLogin yes/" /etc/ssh/sshd_config \
    && sed -i "s/#PubkeyAuthentication.*/PubkeyAuthentication yes/" /etc/ssh/sshd_config \
    && sed -i "s/#PasswordAuthentication.*/PasswordAuthentication yes/" /etc/ssh/sshd_config

# ============================================
# Create yubo user with sudo access
# ============================================
RUN useradd -m -s /bin/bash -G sudo yubo \
    && echo "yubo:yubo" | chpasswd \
    && echo "yubo ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers \
    && mkdir -p /home/yubo/.ssh \
    && chmod 700 /home/yubo/.ssh

# ============================================
# Git Configuration
# ============================================
RUN git config --system user.name "yubo-ruan" \
    && git config --system user.email "yubo@8dcapital.com" \
    && git config --system init.defaultBranch main

# ============================================
# Python Symlinks (for non-interactive shells like Claude Code)
# ============================================
# Isaac Sim Python is at /isaac-sim/python.sh
# Aliases don't work in non-interactive shells, so we create wrapper scripts
RUN echo '#!/bin/bash' > /usr/local/bin/python \
    && echo 'exec /isaac-sim/python.sh "$@"' >> /usr/local/bin/python \
    && chmod +x /usr/local/bin/python \
    && ln -sf /usr/local/bin/python /usr/local/bin/python3 \
    # Create pip wrapper
    && echo '#!/bin/bash' > /usr/local/bin/pip \
    && echo 'exec /isaac-sim/python.sh -m pip "$@"' >> /usr/local/bin/pip \
    && chmod +x /usr/local/bin/pip \
    && ln -sf /usr/local/bin/pip /usr/local/bin/pip3

# ============================================
# Shell Configuration (root + yubo)
# ============================================
RUN echo 'export OMNIGIBSON_ASSET_PATH=/workspace/omnigibson_assets' >> /root/.bashrc \
    && echo 'cd /workspace' >> /root/.bashrc \
    # yubo user
    && echo 'export OMNIGIBSON_ASSET_PATH=/workspace/omnigibson_assets' >> /home/yubo/.bashrc \
    && echo 'cd /workspace' >> /home/yubo/.bashrc \
    && chown yubo:yubo /home/yubo/.bashrc

# ============================================
# Install BEHAVIOR-1K / OmniGibson from GitHub
# ============================================
# OmniGibson is inside the BEHAVIOR-1K monorepo at OmniGibson/
# ISAAC_SIM_PATH is required for OmniGibson to find Isaac Sim
ENV ISAAC_SIM_PATH=/isaac-sim
ENV ISAACSIM_PATH=/isaac-sim

RUN git clone -b v3.7.1 --depth 1 https://github.com/StanfordVL/BEHAVIOR-1K.git /opt/behavior-1k \
    && cd /opt/behavior-1k/OmniGibson \
    && /isaac-sim/python.sh -m pip install --no-cache-dir -e .

# ============================================
# Install BDDL + other dependencies
# ============================================
# Isaac Sim uses its own Python at /isaac-sim/python.sh
RUN /isaac-sim/python.sh -m pip install --no-cache-dir \
    bddl \
    # Core dependencies (numpy pinned for robosuite/libero compatibility)
    'numpy<2' \
    # Vision model
    transformers \
    timm \
    # Data loading
    h5py \
    # Image processing
    opencv-python \
    Pillow \
    # VLM grounding (Qwen2.5-VL)
    qwen-vl-utils \
    accelerate \
    # Training utilities
    huggingface_hub \
    wandb \
    tqdm \
    rich \
    PyYAML

# ============================================
# Workspace Setup
# ============================================
RUN mkdir -p /workspace/.cache/huggingface \
    && mkdir -p /workspace/.cache/torch \
    && mkdir -p /workspace/omnigibson_assets \
    && mkdir -p /workspace/.claude \
    && chown -R yubo:yubo /workspace \
    # Symlink ~/.claude -> /workspace/.claude for yubo
    && ln -sf /workspace/.claude /home/yubo/.claude \
    && chown -h yubo:yubo /home/yubo/.claude \
    # Symlink ~/.claude -> /workspace/.claude for root
    && ln -sf /workspace/.claude /root/.claude

WORKDIR /workspace

# Copy scripts (setup script to /usr/local/bin so it survives volume mounts)
COPY start.sh /start.sh
COPY setup_omnigibson.sh /usr/local/bin/setup_omnigibson.sh
RUN chmod +x /start.sh /usr/local/bin/setup_omnigibson.sh

# Expose SSH port
EXPOSE 22

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep sshd > /dev/null || exit 1

ENTRYPOINT ["/start.sh"]
